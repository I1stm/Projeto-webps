This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
sitema-regulacao/
  public/
    vite.svg
  src/
    App.css
    App.jsx
    CorpoHumano.jsx
    DadosRegulacao.js
    database_schema.sql
    HeaderSecao.jsx
    Layout.jsx
    Login.jsx
    main.jsx
    ModalForm.jsx
    NovaSenha.jsx
    supabaseClient.js
    Toast.jsx
    ViewerCorpo.jsx
  .gitignore
  eslint.config.js
  index.html
  package.json
  README.md
  vercel.json
  vite.config.js
package.json
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="sitema-regulacao/public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="sitema-regulacao/src/App.css">
/* =========================================
   1. DEFINI√á√ÉO DAS CORES (TEMA VERDE)
   ========================================= */
:root {
  /* TEMA CLARO (Dia) */
  --bg-pagina: #f0f2f5;
  --bg-card: #ffffff;
  --texto-primario: #2c3e50;
  --texto-secundario: #607d8b;
  --borda: #dce0e5;
  
  /* O VERDE (Claro) */
  --destaque: #2e7d32;        /* Verde Esmeralda Escuro */
  --destaque-suave: #e8f5e9;  /* Fundo verde bem clarinho */
  
  --boneco-base: #cfd8dc;     /* Cinza azulado claro */
  --boneco-hover: #b0bec5;
  --input-bg: #ffffff;
}

/* TEMA ESCURO (Noite) */
body.dark-mode {
  --bg-pagina: #121212;
  --bg-card: #1e1e1e;
  --texto-primario: #e0e0e0;
  --texto-secundario: #b0bec5;
  --borda: #333333;

  /* O VERDE (Escuro - Neon) */
  --destaque: #00e676;        /* Verde Matrix/Neon */
  --destaque-suave: #1b5e20;  /* Verde musgo escuro para fundos */
  
  --boneco-base: #424242;     /* Cinza chumbo */
  --boneco-hover: #616161;
  --input-bg: #2c2c2c;
}

/* =========================================
   2. GERAL
   ========================================= */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  background-color: var(--bg-pagina);
  color: var(--texto-primario);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  transition: all 0.3s ease;
}

#root {
  height: 100%;
  display: flex;
  flex-direction: column;
}

/* Scrollbar Bonita */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-pagina); }
::-webkit-scrollbar-thumb { background: var(--borda); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--destaque); }
</file>

<file path="sitema-regulacao/src/DadosRegulacao.js">
export const dadosRegulacao = {
  // ==========================================================
  // 1. REGI√ÉO DA CABE√áA
  // ==========================================================
  cerebro: { 
    nome: "Regi√£o da Cabe√ßa",
    protocolos: [],
    submenus: [
      { label: "Neurologia (C√©rebro)", target: "neurologia" },
      { label: "Oftalmologia (Olhos)", target: "oftalmologia" },
      { label: "Otorrino (Ouvido/Nariz)", target: "otorrino" },
      { label: "Bucomaxilo (Face)", target: "bucomaxilo" }
    ]
  },
  olhos: { nome: "Oftalmologia", protocolos: [], submenus: [{label: "Ver Exames de Vista", target: "oftalmologia"}] },
  mandibula: { nome: "Face", protocolos: [], submenus: [{label: "Ver Bucomaxilo", target: "bucomaxilo"}] },
  ouvidos: { nome: "Ouvidos", protocolos: [], submenus: [{label: "Ver Otorrino", target: "otorrino"}] },

  neurologia: {
    nome: "Neurologia / Neurocirurgia",
    protocolos: [
      { problema: "Cefaleia Cr√¥nica (Enxaqueca)", exame: "Consulta Neurologia", locais: ["Ambulat√≥rio de Especialidades"] },
      { problema: "Suspeita de AVC Pr√©vio", exame: "Tomografia de Cr√¢nio", locais: ["Hospital Regional", "Cl√≠nica de Imagem"] }
    ]
  },
  oftalmologia: {
    nome: "Oftalmologia",
    protocolos: [
      { problema: "Baixa Acuidade Visual", exame: "Consulta Oftalmo Geral", locais: ["Cl√≠nica de Olhos"] },
      { problema: "Catarata (Idoso)", exame: "Avalia√ß√£o Cir√∫rgica Catarata", locais: ["Mutir√£o da Sa√∫de"] }
    ]
  },
  otorrino: {
    nome: "Otorrinolaringologia",
    protocolos: [
      { problema: "Hipoacusia (Surdez)", exame: "Audiometria Tonal e Vocal", locais: ["Centro Auditivo"] },
      { problema: "Sinusite Cr√¥nica", exame: "Videolaringoscopia", locais: ["Cl√≠nica Otorrino"] }
    ]
  },
  bucomaxilo: {
    nome: "Cirurgia Bucomaxilofacial",
    protocolos: [
      { problema: "Disfun√ß√£o de ATM (Estalos)", exame: "Consulta Bucomaxilo", locais: ["CEO - Centro Odontol√≥gico"] }
    ]
  },

  // ==========================================================
  // 2. REGI√ÉO DO PESCO√áO
  // ==========================================================
  pescoco: {
    nome: "Pesco√ßo",
    protocolos: [],
    submenus: [
      { label: "Tireoide (End√≥crino)", target: "tireoide" },
      { label: "Linfonodos / Cistos", target: "partesMolesPescoco" }
    ]
  },
  tireoide: {
    nome: "Tireoide",
    protocolos: [
      { problema: "B√≥cio / N√≥dulo", exame: "USG Tireoide com Doppler", locais: ["Cl√≠nica de Imagem"] },
      { problema: "Hipotireoidismo", exame: "Exames Laboratoriais (TSH/T4)", locais: ["Laborat√≥rio Municipal"] }
    ]
  },
  partesMolesPescoco: {
    nome: "Partes Moles (Pesco√ßo)",
    protocolos: [
      { problema: "Cisto Tireoglosso / √çngua", exame: "USG Cervical", locais: ["Cl√≠nica de Imagem"] }
    ]
  },

  // ==========================================================
  // 3. T√ìRAX (Cora√ß√£o, Pulm√£o, Mamas)
  // ==========================================================
  peito: {
    nome: "T√≥rax / Peito",
    protocolos: [],
    submenus: [
      { label: "Cardiologia (Cora√ß√£o)", target: "cardiologia" },
      { label: "Pneumologia (Pulm√£o)", target: "pneumologia" },
      { label: "Mastologia (Mamas)", target: "mastologia" },
      { label: "Arcabou√ßo Costal (Ossos)", target: "arcaboucoCostal" }
    ]
  },
  cardiologia: {
    nome: "Cardiologia",
    protocolos: [
      { problema: "Dor Tor√°cica / Angina", exame: "Teste Ergom√©trico", locais: ["Cl√≠nica do Cora√ß√£o", "Hospital Regional"] },
      { problema: "Arritmia / Palpita√ß√£o", exame: "Holter 24h", locais: ["Cl√≠nica do Cora√ß√£o"] }
    ]
  },
  pneumologia: {
    nome: "Pneumologia",
    protocolos: [
      { problema: "Asma / DPOC", exame: "Espirometria", locais: ["Ambulat√≥rio Pneumo"] },
      { problema: "N√≥dulo Pulmonar", exame: "Tomografia de T√≥rax", locais: ["Hospital Regional"] }
    ]
  },
  mastologia: {
    nome: "Mastologia / Mamas",
    protocolos: [
      { problema: "Rastreio (40+ anos)", exame: "Mamografia Bilateral", locais: ["Cl√≠nica da Mulher"] },
      { problema: "N√≥dulo Palp√°vel", exame: "USG Mamas", locais: ["Cl√≠nica da Mulher", "Hospital Regional"] }
    ]
  },
  arcaboucoCostal: {
    nome: "Parede Tor√°cica",
    protocolos: [
      { problema: "Dor p√≥s-trauma", exame: "Raio-X de Arcos Costais", locais: ["UPA", "Hospital Municipal"] }
    ]
  },

  // ==========================================================
  // 4. ABD√îMEN E PELVE
  // ==========================================================
  abdomen: { 
    nome: "Abd√¥men", 
    protocolos: [],
    submenus: [
      { label: "Est√¥mago / Digestivo", target: "gastro" },
      { label: "F√≠gado / Ves√≠cula", target: "figado" },
      { label: "Rins / Urin√°rio", target: "rins" },
      { label: "Parede Abdominal (H√©rnia)", target: "paredeAbdominal" }
    ]
  },
  gastro: {
    nome: "Gastroenterologia",
    protocolos: [{ problema: "Gastrite / Refluxo", exame: "Endoscopia Digestiva Alta", locais: ["Hospital Municipal"] }]
  },
  figado: {
    nome: "F√≠gado e Ves√≠cula",
    protocolos: [{ problema: "Pedra na Ves√≠cula (Colel√≠tiase)", exame: "USG Abdome Superior", locais: ["Cl√≠nica de Imagem"] }]
  },
  rins: {
    nome: "Nefro / Urologia",
    protocolos: [{ problema: "C√°lculo Renal (Pedra)", exame: "Tomografia de Vias Urin√°rias", locais: ["Regional"] }]
  },
  paredeAbdominal: {
    nome: "Cirurgia Geral",
    protocolos: [{ problema: "H√©rnia Umbilical / Inguinal", exame: "Consulta Cirurgi√£o Geral", locais: ["Ambulat√≥rio Cir√∫rgico"] }]
  },

  pelvis: { 
    nome: "Pelve / Bacia", 
    protocolos: [],
    submenus: [
      { label: "Ginecologia (Mulher)", target: "ginecologia" },
      { label: "Urologia (Homem)", target: "urologia" },
      { label: "Quadril (Ortopedia)", target: "quadril" }
    ]
  },
  ginecologia: {
    nome: "Ginecologia",
    protocolos: [{ problema: "Sangramento Uterino", exame: "USG Transvaginal", locais: ["Cl√≠nica da Mulher"] }]
  },
  urologia: {
    nome: "Urologia (Pr√≥stata)",
    protocolos: [{ problema: "HPB / Pr√≥stata Aumentada", exame: "USG Pr√≥stata + PSA", locais: ["Laborat√≥rio", "Imagem"] }]
  },
  quadril: {
    nome: "Ortopedia (Quadril)",
    protocolos: [{ problema: "Artrose de Quadril", exame: "Raio-X de Bacia", locais: ["UPA"] }]
  },

  // ==========================================================
  // 5. COLUNA (Vis√£o Costas)
  // ==========================================================
  nuca: { nome: "Coluna Cervical", protocolos: [], submenus: [{label: "Ver Cervical", target: "colunaCervical"}]},
  
  colunaCervical: { 
    nome: "Coluna Cervical (Pesco√ßo)", 
    protocolos: [{ problema: "Cervicalgia", exame: "Raio-X Coluna Cervical", locais: ["UPA"] }]
  },
  colunaToracica: { 
    nome: "Coluna Tor√°cica (Dorso)", 
    protocolos: [{ problema: "Dor Dorsal", exame: "Raio-X Coluna Tor√°cica", locais: ["UPA"] }]
  },
  colunaLombar: { 
    nome: "Coluna Lombar", 
    protocolos: [],
    submenus: [
      { label: "Dor Lombar Comum", target: "lombalgia" },
      { label: "H√©rnia / Nervo Ci√°tico", target: "herniaDisco" }
    ]
  },
  lombalgia: {
    nome: "Lombalgia Mec√¢nica",
    protocolos: [{ problema: "Dor Lombar", exame: "Raio-X Coluna Lombar", locais: ["UPA", "Hospital"] }]
  },
  herniaDisco: {
    nome: "Doen√ßas do Disco",
    protocolos: [{ problema: "H√©rnia de Disco / Radiculopatia", exame: "Resson√¢ncia Magn√©tica", locais: ["Cl√≠nica de Imagem"] }]
  },

  // ==========================================================
  // 6. MEMBROS SUPERIORES E INFERIORES
  // ==========================================================
  
  // -- AQUI ESTAVA O ERRO (Corrigido para 'protocolos') --
  ombroDireito: { nome: "Ombro Direito", protocolos: [], submenus: [{label: "Ortopedia Ombro", target: "ortopediaOmbro"}] },
  ombroEsquerdo: { nome: "Ombro Esquerdo", protocolos: [], submenus: [{label: "Ortopedia Ombro", target: "ortopediaOmbro"}] },
  ortopediaOmbro: {
    nome: "Ombro",
    protocolos: [{ problema: "Bursite / Tendinite", exame: "USG de Ombro", locais: ["Cl√≠nica de Imagem"] }]
  },
  
  bracoDireito: { nome: "Bra√ßo Direito", protocolos: [] }, // Corrigido
  bracoEsquerdo: { nome: "Bra√ßo Esquerdo", protocolos: [] }, // Corrigido
  
  maoDireita: {
    nome: "M√£o e Punho",
    protocolos: [],
    submenus: [
      { label: "Punho (Articula√ß√£o)", target: "punho" },
      { label: "Dedos / M√£o", target: "dedos" }
    ]
  },
  maoEsquerda: { nome: "M√£o Esquerda", protocolos: [], submenus: [{ label: "Ver Op√ß√µes M√£o", target: "maoDireita"}] }, 
  
  punho: {
    nome: "Punho",
    protocolos: [{ problema: "Cisto Sinovial", exame: "USG Articular", locais: ["Regional"] }]
  },
  dedos: {
    nome: "M√£o e Dedos",
    protocolos: [{ problema: "Fratura / Trauma", exame: "Raio-X de M√£o", locais: ["UPA"] }]
  },

  // -- INFERIORES --
  pernaDireita: { 
    nome: "Membro Inferior Direito", 
    protocolos: [],
    submenus: [
      { label: "Joelho", target: "joelho" },
      { label: "Vascular (Varizes)", target: "vascular" },
      { label: "Tornozelo e P√©", target: "pe" }
    ]
  },
  pernaEsquerda: { nome: "Membro Inferior Esquerdo", protocolos: [], submenus: [{ label: "Ver Op√ß√µes Perna", target: "pernaDireita"}] },

  joelho: {
    nome: "Joelho",
    protocolos: [
      { problema: "Artrose de Joelho", exame: "Raio-X de Joelho Carga", locais: ["UPA"] },
      { problema: "Les√£o de Menisco/Ligamento", exame: "Resson√¢ncia Magn√©tica", locais: ["Cl√≠nica de Imagem"] }
    ]
  },
  vascular: {
    nome: "Cirurgia Vascular",
    protocolos: [
      { problema: "Varizes / Insuf. Venosa", exame: "Doppler Colorido Venoso", locais: ["Hospital Regional", "Cl√≠nica Vascular"] }
    ]
  },
  pe: {
    nome: "Tornozelo e P√©",
    protocolos: [
      { problema: "Entorse / Trauma", exame: "Raio-X Tornozelo/P√©", locais: ["UPA"] },
      { problema: "Espor√£o de Calc√¢neo", exame: "Raio-X Calc√¢neo", locais: ["UPA"] }
    ]
  },
  
  // Itens extras das costas
  gluteos: { nome: "Gl√∫teos", protocolos: [] },
  posteriorCoxaDireita: { nome: "Posterior de Coxa", protocolos: [] },
  panturrilhaDireita: { nome: "Panturrilha", protocolos: [] }
};
</file>

<file path="sitema-regulacao/src/database_schema.sql">
-- ###########################################################
-- SCHEMA DE BANCO DE DADOS - SISREG PRO
-- Data de Cria√ß√£o: 01/02/2026
-- ###########################################################

-- 1. TABELAS PRINCIPAIS
CREATE TABLE IF NOT EXISTS public.body_parts (
    id TEXT PRIMARY KEY,
    display_name TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS public.sub_areas (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    body_part_id TEXT REFERENCES public.body_parts(id),
    name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.protocols (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    body_part_id TEXT REFERENCES public.body_parts(id),
    sub_area_id UUID REFERENCES public.sub_areas(id),
    problema TEXT NOT NULL,
    locais TEXT,
    exame TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
    email TEXT,
    role TEXT DEFAULT 'user'
);

-- 2. TABELA DE AUDITORIA (LOGS)
CREATE TABLE IF NOT EXISTS public.audit_logs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    tabela_nome TEXT,
    item_id TEXT,
    operacao TEXT,
    usuario_email TEXT,
    dados_antigos JSONB,
    dados_novos JSONB,
    data_hora TIMESTAMPTZ DEFAULT now()
);

-- 3. SEGURAN√áA (RLS)
ALTER TABLE public.body_parts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sub_areas ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.protocols ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.audit_logs ENABLE ROW LEVEL SECURITY;

-- Exemplo de Pol√≠ticas (Repetir para as outras conforme necess√°rio)
CREATE POLICY "Leitura p√∫blica" ON public.protocols FOR SELECT USING (true);
CREATE POLICY "Admin total" ON public.protocols FOR ALL USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
);

-- 4. FUN√á√ïES E TRIGGERS (A L√ìGICA DO BANCO)
CREATE OR REPLACE FUNCTION public.registrar_auditoria()
RETURNS TRIGGER AS $$
DECLARE v_user_email TEXT;
BEGIN
    v_user_email := (SELECT email FROM auth.users WHERE id = auth.uid());
    IF (TG_OP = 'DELETE') THEN
        INSERT INTO public.audit_logs (tabela_nome, item_id, operacao, usuario_email, dados_antigos)
        VALUES (TG_TABLE_NAME, OLD.id::text, TG_OP, v_user_email, to_jsonb(OLD));
        RETURN OLD;
    ELSIF (TG_OP = 'UPDATE') THEN
        INSERT INTO public.audit_logs (tabela_nome, item_id, operacao, usuario_email, dados_antigos, dados_novos)
        VALUES (TG_TABLE_NAME, NEW.id::text, TG_OP, v_user_email, to_jsonb(OLD), to_jsonb(NEW));
        RETURN NEW;
    ELSE -- INSERT
        INSERT INTO public.audit_logs (tabela_nome, item_id, operacao, usuario_email, dados_novos)
        VALUES (TG_TABLE_NAME, NEW.id::text, TG_OP, v_user_email, to_jsonb(NEW));
        RETURN NEW;
    END IF;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE TRIGGER tr_auditoria_protocolos 
AFTER INSERT OR UPDATE OR DELETE ON public.protocols
FOR EACH ROW EXECUTE PROCEDURE registrar_auditoria();
</file>

<file path="sitema-regulacao/src/Layout.jsx">
import React from 'react';

const Layout = ({ children }) => {
  return (
    <div style={styles.containerPrincipal}>
      {/* --- CABE√áALHO (NAVBAR) --- */}
      <header style={styles.cabecalho}>
        <div style={styles.logoArea}>
          <span style={styles.iconeMedico}>‚úö</span>
          <h1 style={styles.tituloSistema}>SisReg Sa√∫de</h1>
        </div>
        <div style={styles.usuario}>
          <span>Ol√°, Regulador</span>
          <div style={styles.avatar}>R</div>
        </div>
      </header>

      {/* --- CONTE√öDO (AQUI ENTRA O BONECO E O PAINEL) --- */}
      <main style={styles.conteudo}>
        <div style={styles.cardBranco}>
          {children} 
        </div>
      </main>

      {/* --- RODAP√â --- */}
      <footer style={styles.rodape}>
        <p>Sistema de Apoio √† Regula√ß√£o - Vers√£o 1.0 Alpha</p>
      </footer>
    </div>
  );
};

// Estilos CSS dentro do JavaScript (CSS-in-JS)
const styles = {
  containerPrincipal: {
    fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
    backgroundColor: '#f0f2f5', // Fundo cinza claro padr√£o de sistemas
    minHeight: '100vh',
    display: 'flex',
    flexDirection: 'column',
  },
  cabecalho: {
    backgroundColor: '#0277bd', // Azul "Hospital"
    color: 'white',
    padding: '0 20px',
    height: '60px',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'space-between',
    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
  },
  logoArea: {
    display: 'flex',
    alignItems: 'center',
    gap: '10px'
  },
  iconeMedico: {
    fontSize: '24px',
    fontWeight: 'bold'
  },
  tituloSistema: {
    fontSize: '18px',
    margin: 0,
    fontWeight: 500
  },
  usuario: {
    display: 'flex',
    alignItems: 'center',
    gap: '10px',
    fontSize: '14px'
  },
  avatar: {
    width: '32px',
    height: '32px',
    backgroundColor: 'white',
    color: '#0277bd',
    borderRadius: '50%',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    fontWeight: 'bold'
  },
  conteudo: {
    flex: 1, // Ocupa todo o espa√ßo sobrando
    padding: '20px',
    display: 'flex',
    justifyContent: 'center',
  },
  cardBranco: {
    backgroundColor: 'white',
    width: '100%',
    maxWidth: '1200px', // Limita a largura para n√£o ficar esticado em monitores gigantes
    borderRadius: '8px',
    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
    overflow: 'hidden', // Garante que nada saia do card
    display: 'flex', // Para o layout interno funcionar
    flexDirection: 'row' // Garante lado a lado
  },
  rodape: {
    textAlign: 'center',
    padding: '10px',
    fontSize: '12px',
    color: '#666',
    borderTop: '1px solid #ddd'
  }
};

export default Layout;
</file>

<file path="sitema-regulacao/src/main.jsx">
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
</file>

<file path="sitema-regulacao/src/NovaSenha.jsx">
import React, { useState } from 'react';
import { supabase } from './supabaseClient';

export default function NovaSenha({ aoFinalizar }) {
  const [senha, setSenha] = useState('');
  const [loading, setLoading] = useState(false);
  const [mensagem, setMensagem] = useState(null);

  const handleUpdate = async (e) => {
    e.preventDefault();
    setLoading(true);

    const { error } = await supabase.auth.updateUser({ password: senha });

    if (error) {
      setMensagem({ tipo: 'erro', texto: 'Erro: ' + error.message });
      setLoading(false);
    } else {
      setMensagem({ tipo: 'sucesso', texto: 'Senha alterada com sucesso!' });
      // Aguarda 1.5s para o usu√°rio ler a mensagem antes de fechar
      setTimeout(() => {
        aoFinalizar();
      }, 1500);
    }
  };

  return (
    <div style={{
      position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
      backgroundColor: 'rgba(0,0,0,0.8)', zIndex: 2000,
      display: 'flex', alignItems: 'center', justifyContent: 'center'
    }}>
      <div style={{
        backgroundColor: 'var(--bg-card)', padding: '30px', borderRadius: '12px',
        width: '90%', maxWidth: '350px', border: '1px solid var(--destaque)',
        boxShadow: '0 0 20px rgba(0,0,0,0.5)'
      }}>
        <h2 style={{ color: 'var(--destaque)', marginTop: 0, textAlign: 'center' }}>Nova Senha</h2>
        <p style={{ fontSize:'14px', color:'var(--texto-secundario)', textAlign: 'center', marginBottom: '20px' }}>
          Digite sua nova senha abaixo para recuperar o acesso.
        </p>
        
        <form onSubmit={handleUpdate} style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
          <input 
            type="password" 
            placeholder="Nova senha (min. 6 caracteres)"
            value={senha}
            onChange={e => setSenha(e.target.value)}
            required
            minLength={6}
            style={{ width: '100%', padding: '12px', borderRadius: '6px', border: '1px solid var(--borda)', background: 'var(--input-bg)', color: 'var(--texto-primario)' }}
          />
          
          {mensagem && (
            <div style={{ 
              color: mensagem.tipo === 'erro' ? '#ff5252' : '#00e676', 
              fontSize: '13px', textAlign: 'center', padding: '8px', 
              backgroundColor: mensagem.tipo === 'erro' ? 'rgba(255, 82, 82, 0.1)' : 'rgba(0, 230, 118, 0.1)', 
              borderRadius: '4px' 
            }}>
              {mensagem.texto}
            </div>
          )}

          <button 
            type="submit" 
            disabled={loading} 
            style={{ 
              width:'100%', padding:'12px', background:'var(--destaque)', color:'#fff', 
              border:'none', borderRadius: '8px', cursor: loading ? 'not-allowed' : 'pointer', fontWeight: 'bold' 
            }}>
            {loading ? 'Salvando...' : 'Salvar Nova Senha'}
          </button>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="sitema-regulacao/src/supabaseClient.js">
// src/supabaseClient.js
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = 'https://czcksdlxuovenbhyabne.supabase.co'
const supabaseAnonKey = 'sb_publishable_GG0_i90KCnsUKgH4E-PLKQ_RdqD_sLn'

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
</file>

<file path="sitema-regulacao/src/Toast.jsx">
import React, { useEffect } from 'react';

export default function Toast({ mensagem, tipo, onClose }) {
  // tipo pode ser 'sucesso' (verde) ou 'erro' (vermelho)
  
  // Fecha sozinho depois de 3 segundos
  useEffect(() => {
    const timer = setTimeout(() => {
      onClose();
    }, 3000);
    return () => clearTimeout(timer);
  }, [onClose]);

  return (
    <div style={{
      position: 'fixed',
      bottom: '20px',
      right: '20px',
      backgroundColor: tipo === 'erro' ? '#ff5252' : '#00e676', // Vermelho ou Verde Neon
      color: '#fff',
      padding: '15px 20px',
      borderRadius: '8px',
      boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
      zIndex: 10000,
      display: 'flex',
      alignItems: 'center',
      gap: '10px',
      animation: 'slideIn 0.3s ease-out',
      fontWeight: 'bold',
      fontSize: '14px'
    }}>
      <span>{tipo === 'erro' ? '‚ùå' : '‚úÖ'}</span>
      {mensagem}
    </div>
  );
}
</file>

<file path="sitema-regulacao/.gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="sitema-regulacao/eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])
</file>

<file path="sitema-regulacao/index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sitema-regulacao</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="sitema-regulacao/vercel.json">
{
  "rewrites": [{ "source": "/(.*)", "destination": "/index.html" }]
}
</file>

<file path="sitema-regulacao/vite.config.js">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})
</file>

<file path="package.json">
{
  "dependencies": {
    "@supabase/supabase-js": "^2.93.2"
  }
}
</file>

<file path="sitema-regulacao/src/HeaderSecao.jsx">
import React, { useState, useEffect } from 'react';
import { supabase } from './supabaseClient'; 

const HeaderSecao = ({ 
  parteSelecionada, 
  nomeAtual,        // <--- Novo: Recebe o nome bonito do banco
  isAdmin, 
  modoEdicao, 
  aoAbrirModalProtocolo, 
  aoAtualizar,
  onRename          // <--- Novo: Fun√ß√£o para salvar a renomea√ß√£o
}) => {
  
  // --- L√≥gica de Renomear T√≠tulo ---
  const [editando, setEditando] = useState(false);
  const [novoNome, setNovoNome] = useState('');

  // Sincroniza quando muda a parte selecionada
  useEffect(() => {
    setNovoNome(nomeAtual || '');
  }, [nomeAtual]);

  const handleSalvarNome = async () => {
    if (novoNome.trim() !== '' && novoNome !== nomeAtual) {
      await onRename(novoNome);
    }
    setEditando(false);
  };

  const handleCancelarEdicao = () => {
    setNovoNome(nomeAtual || '');
    setEditando(false);
  };

  // --- L√≥gica Original de Criar Submenu ---
  const handleCriarSubmenu = async () => {
    if (!parteSelecionada) return;

    const nome = prompt(`Nome da nova Categoria para ${nomeAtual || parteSelecionada}:`);
    if (!nome) return;

    const { error } = await supabase
      .from('sub_areas')
      .insert([{ body_part_id: parteSelecionada, name: nome }]);

    if (error) {
      console.error(error);
      if (error.code === '23503') {
        alert(`ERRO CR√çTICO: O ID "${parteSelecionada}" n√£o existe na tabela 'body_parts'.`);
      } else {
        alert(`Erro ao criar: ${error.message}`);
      }
    } else {
      if (aoAtualizar) aoAtualizar();
    }
  };

  return (
    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '10px' }}>
      
      {/* T√çTULO EDIT√ÅVEL */}
      <div style={{ flex: 1 }}>
        {editando ? (
          <div style={{ display: 'flex', alignItems: 'center', gap: '5px' }}>
            <input 
              autoFocus
              type="text" 
              value={novoNome} 
              onChange={(e) => setNovoNome(e.target.value)}
              style={{ 
                fontSize: '24px', fontWeight: 'bold', color: 'var(--destaque)', 
                background: 'transparent', border: 'none', borderBottom: '2px solid var(--destaque)',
                outline: 'none', width: '100%', maxWidth: '300px'
              }}
            />
            <button onClick={handleSalvarNome} style={{ cursor: 'pointer', background: '#00e676', border: 'none', borderRadius: '4px', color: '#fff', padding: '5px 10px', fontWeight: 'bold' }}>‚úì</button>
            <button onClick={handleCancelarEdicao} style={{ cursor: 'pointer', background: '#ff5252', border: 'none', borderRadius: '4px', color: '#fff', padding: '5px 10px', fontWeight: 'bold' }}>‚úï</button>
          </div>
        ) : (
          <h2 style={{ color: 'var(--destaque)', margin: 0, textTransform: 'capitalize', fontSize: '24px', display: 'flex', alignItems: 'center', gap: '10px' }}>
            {nomeAtual || (parteSelecionada ? parteSelecionada.replace(/-/g, ' ') : 'Selecione...')}
            
            {/* L√°pis de Edi√ß√£o */}
            {modoEdicao && isAdmin && parteSelecionada && (
              <button 
                onClick={() => setEditando(true)}
                title="Renomear Parte"
                style={{ 
                  background: 'transparent', border: '1px solid var(--destaque)', borderRadius: '50%', 
                  width: '24px', height: '24px', display: 'flex', alignItems: 'center', justifyContent: 'center',
                  cursor: 'pointer', color: 'var(--destaque)', fontSize: '12px'
                }}
              >
                ‚úé
              </button>
            )}
          </h2>
        )}
      </div>

      {/* BOT√ïES DE A√á√ÉO (S√≥ Admins) */}
      {modoEdicao && isAdmin && (
        <div style={{ display: 'flex', gap: '10px' }}>
          {/* Bot√£o AZUL - Submenu */}
          <button 
            onClick={handleCriarSubmenu} 
            style={{ 
              background: '#3b82f6', color: '#fff', border: 'none', padding: '8px 16px', 
              borderRadius: '20px', cursor: 'pointer', fontWeight: 'bold', 
              boxShadow: '0 4px 6px rgba(0,0,0,0.2)',
              display: 'flex', alignItems: 'center', gap: '5px'
            }}
          >
            <span>+</span> Criar Submenu
          </button>

          {/* Bot√£o VERDE - Protocolo */}
          <button 
            onClick={aoAbrirModalProtocolo} 
            style={{ 
              background: 'var(--destaque)', color: '#fff', border: 'none', padding: '8px 16px', 
              borderRadius: '20px', cursor: 'pointer', fontWeight: 'bold',
              boxShadow: '0 4px 6px rgba(0,0,0,0.2)' 
            }}
          >
            + Novo Protocolo
          </button>
        </div>
      )}
    </div>
  );
};

export default HeaderSecao;
</file>

<file path="sitema-regulacao/src/ModalForm.jsx">
import React, { useState, useEffect } from 'react';

export default function ModalForm({ isOpen, onClose, onSave, itemEdicao }) {
  // Estados do formul√°rio
  const [problema, setProblema] = useState('');
  const [locais, setLocais] = useState('');
  const [informacoes, setInformacoes] = useState(''); // Novo campo
  const [exame, setExame] = useState('');

  // Quando o modal abre, preenche os dados se for edi√ß√£o
  useEffect(() => {
    if (isOpen) {
      if (itemEdicao) {
        setProblema(itemEdicao.problema || '');
        setLocais(itemEdicao.locais || '');
        setInformacoes(itemEdicao.informacoes || ''); // Carrega info existente
        setExame(itemEdicao.exame || '');
      } else {
        // Limpa se for criar novo
        setProblema('');
        setLocais('');
        setInformacoes('');
        setExame('');
      }
    }
  }, [isOpen, itemEdicao]);

  if (!isOpen) return null;

  const handleSubmit = (e) => {
    e.preventDefault();
    // Envia o objeto completo de volta para o App.jsx
    onSave({ 
      problema, 
      locais, 
      informacoes, // Envia a nova info
      exame 
    });
  };

  return (
    <div style={{
      position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
      backgroundColor: 'rgba(0,0,0,0.7)', zIndex: 1000,
      display: 'flex', alignItems: 'center', justifyContent: 'center'
    }}>
      <div style={{
        backgroundColor: 'var(--bg-card)', padding: '25px', borderRadius: '12px',
        width: '90%', maxWidth: '500px', position: 'relative',
        border: '1px solid var(--borda)', boxShadow: '0 4px 20px rgba(0,0,0,0.3)'
      }}>
        <h2 style={{ marginTop: 0, color: 'var(--destaque)' }}>
          {itemEdicao ? 'Editar Protocolo' : 'Novo Protocolo'}
        </h2>

        <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
          
          {/* PROBLEMA */}
          <div>
            <label style={{ display: 'block', fontSize: '13px', color: 'var(--texto-secundario)', marginBottom: '5px' }}>Problema / Doen√ßa</label>
            <input 
              type="text" 
              required
              value={problema} 
              onChange={(e) => setProblema(e.target.value)} 
              placeholder="Ex: Fratura exposta"
              style={inputStyle} 
            />
          </div>

          {/* LOCAIS DE ATENDIMENTO */}
          <div>
            <label style={{ display: 'block', fontSize: '13px', color: 'var(--texto-secundario)', marginBottom: '5px' }}>Locais de Atendimento (separe por /)</label>
            <input 
              type="text" 
              required
              value={locais} 
              onChange={(e) => setLocais(e.target.value)} 
              placeholder="Ex: UPA / Hospital Municipal"
              style={inputStyle} 
            />
          </div>

          {/* NOVO CAMPO: INFORMA√á√ïES */}
          <div>
            <label style={{ display: 'block', fontSize: '13px', color: 'var(--texto-secundario)', marginBottom: '5px' }}>‚ÑπÔ∏è Informa√ß√µes Adicionais</label>
            <textarea 
              rows="3"
              value={informacoes} 
              onChange={(e) => setInformacoes(e.target.value)} 
              placeholder="Ex: Paciente precisa estar em jejum; Levar documento original..."
              style={{ ...inputStyle, resize: 'vertical' }} 
            />
          </div>

          {/* EXAME / PROCEDIMENTO */}
          <div>
            <label style={{ display: 'block', fontSize: '13px', color: 'var(--texto-secundario)', marginBottom: '5px' }}>Exame ou Procedimento</label>
            <input 
              type="text" 
              value={exame} 
              onChange={(e) => setExame(e.target.value)} 
              placeholder="Ex: Raio-X de T√≥rax"
              style={inputStyle} 
            />
          </div>

          <div style={{ display: 'flex', gap: '10px', marginTop: '10px', justifyContent: 'flex-end' }}>
            <button type="button" onClick={onClose} style={{ padding: '10px 20px', borderRadius: '8px', border: '1px solid var(--borda)', background: 'transparent', color: 'var(--texto-primario)', cursor: 'pointer' }}>Cancelar</button>
            <button type="submit" style={{ padding: '10px 20px', borderRadius: '8px', border: 'none', background: 'var(--destaque)', color: '#fff', fontWeight: 'bold', cursor: 'pointer' }}>Salvar</button>
          </div>
        </form>
      </div>
    </div>
  );
}

const inputStyle = {
  width: '100%', 
  padding: '10px', 
  borderRadius: '6px', 
  border: '1px solid var(--borda)', 
  background: 'var(--input-bg)', 
  color: 'var(--texto-primario)', 
  outline: 'none',
  fontFamily: 'inherit'
};
</file>

<file path="sitema-regulacao/package.json">
{
  "name": "sistema-regulacao",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "@supabase/supabase-js": "^2.39.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.43",
    "@types/react-dom": "^18.2.17",
    "@vitejs/plugin-react": "^4.2.1",
    "eslint": "^8.55.0",
    "eslint-plugin-react": "^7.33.2",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.5",
    "vite": "^5.0.8"
  }
}
</file>

<file path="sitema-regulacao/README.md">
# üè• SISREG PRO - Sistema de Regula√ß√£o de Protocolos M√©dicos

> Sistema web interativo para consulta e gest√£o de protocolos m√©dicos e de regula√ß√£o, com foco em usabilidade, performance e seguran√ßa de dados.

![Status](https://img.shields.io/badge/STATUS-EM_DESENVOLVIMENTO-green)
![Tech](https://img.shields.io/badge/STACK-REACT_%7C_SUPABASE-blue)

## üéØ Sobre o Projeto

O **SISREG PRO** foi desenvolvido para otimizar o processo de consulta de diretrizes m√©dicas. Diferente de PDFs est√°ticos ou planilhas extensas, o sistema oferece uma interface visual baseada na anatomia humana, permitindo que o regulador encontre a informa√ß√£o necess√°ria com poucos cliques.

O projeto implementa uma arquitetura **Full Stack Serverless**, utilizando React no Frontend e Supabase (PostgreSQL) no Backend, com forte √™nfase em Seguran√ßa a N√≠vel de Banco de Dados (RLS).

## üöÄ Funcionalidades Principais

### üß† Navega√ß√£o Intuitiva
- **Mapa Corporal Interativo (SVG):** Sele√ß√£o de protocolos clicando diretamente nas partes do corpo (Frente/Costas).
- **Busca Global Indexada:** Pesquisa r√°pida por problema, tipo de exame ou c√≥digos.
- **Dark Mode:** Interface adapt√°vel para conforto visual.

### üõ°Ô∏è Seguran√ßa e Controle de Acesso (RBAC)
O sistema possui uma hierarquia de permiss√µes rigorosa implementada no Backend:

1.  **üëë Super Admin:**
    - Acesso total ao sistema.
    - **Gest√£o de Equipe:** Poder exclusivo para promover ou rebaixar usu√°rios.
    - Visualiza√ß√£o de logs de auditoria (em roadmap).
2.  **üîí Admin:**
    - Pode Criar, Editar e Excluir protocolos e sub√°reas.
    - N√£o tem acesso √† gest√£o de usu√°rios.
3.  **üë§ User:**
    - Acesso apenas para leitura e consulta.
4.  **Visitante:**
    - Bloqueio total. O sistema exige autentica√ß√£o para exibir qualquer dado.

## üõ†Ô∏è Tecnologias Utilizadas

- **Frontend:** React.js (Vite), CSS Modules (Responsivo).
- **Backend / Database:** Supabase (PostgreSQL).
- **Autentica√ß√£o:** Supabase Auth (Email/Password).
- **Seguran√ßa:** PostgreSQL Row Level Security (RLS).
- **Deploy:** Vercel.

## üîí Arquitetura de Seguran√ßa (Destaque T√©cnico)

Este projeto n√£o depende apenas do Frontend para seguran√ßa. As regras s√£o aplicadas diretamente no banco de dados via **RLS (Row Level Security)**.

- **Prote√ß√£o contra ataques via F12:** Mesmo que um usu√°rio mal-intencionado manipule o estado do React para habilitar bot√µes de "Excluir", o banco de dados rejeitar√° a requisi√ß√£o se o token de sess√£o n√£o tiver a `role` correta.
- **Preven√ß√£o de Loops Infinitos:** Utiliza√ß√£o de fun√ß√µes `SECURITY DEFINER` para checagem de cargos sem causar recursividade nas pol√≠ticas de acesso.
- **Triggers Autom√°ticos:** Gatilhos SQL (`plpgsql`) que criam automaticamente o perfil do usu√°rio e definem permiss√µes padr√£o ao registrar uma nova conta.

## üìÇ Estrutura do Banco de Dados

O esquema do banco de dados inclui:
- `protocols`: Tabela principal com regras de neg√≥cio.
- `body_parts` & `sub_areas`: Tabelas relacionais para categoriza√ß√£o.
- `profiles`: Extens√£o da tabela de usu√°rios para gest√£o de cargos (roles).
- `audit_logs`: Registro de altera√ß√µes para compliance.

*O esquema completo pode ser encontrado no arquivo `database_schema.sql` na raiz do projeto.*

## üíª Como Rodar Localmente

1. Clone o reposit√≥rio:
```bash
git clone [https://github.com/SEU-USUARIO/SEU-REPOSITORIO.git](https://github.com/SEU-USUARIO/SEU-REPOSITORIO.git)
</file>

<file path="sitema-regulacao/src/Login.jsx">
import React, { useState } from 'react';
import { supabase } from './supabaseClient';

export default function Login({ aoFechar }) {
  const [modoRecuperacao, setModoRecuperacao] = useState(false);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [mensagem, setMensagem] = useState(null); // Objeto { tipo: 'erro'|'sucesso', texto: '' }

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setMensagem(null);

    const { error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      setMensagem({ 
        tipo: 'erro', 
        texto: error.message === 'Invalid login credentials' ? 'E-mail ou senha incorretos.' : error.message 
      });
      setLoading(false);
    } else {
      aoFechar();
    }
  };

  const handleRecuperacao = async (e) => {
    e.preventDefault();
    setLoading(true);
    setMensagem(null);

    // Envia o link m√°gico para o e-mail
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.origin, // Garante que volta para a URL correta (Localhost ou Vercel)
    });

    if (error) {
      setMensagem({ tipo: 'erro', texto: 'Erro ao enviar: ' + error.message });
    } else {
      setMensagem({ tipo: 'sucesso', texto: 'Verifique seu e-mail (inclusive Spam) para redefinir a senha!' });
    }
    setLoading(false);
  };

  return (
    <div style={{
      position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
      backgroundColor: 'rgba(0,0,0,0.6)', zIndex: 1000,
      display: 'flex', alignItems: 'center', justifyContent: 'center'
    }}>
      <div style={{
        backgroundColor: 'var(--bg-card)', padding: '30px', borderRadius: '12px',
        width: '90%', maxWidth: '350px', position: 'relative',
        boxShadow: '0 4px 20px rgba(0,0,0,0.3)', border: '1px solid var(--borda)'
      }}>
        <button 
          onClick={aoFechar}
          style={{ position: 'absolute', top: '10px', right: '10px', background: 'transparent', border: 'none', color: 'var(--texto-secundario)', cursor: 'pointer', fontSize: '16px' }}>
          ‚úï
        </button>

        <h2 style={{ color: 'var(--destaque)', textAlign: 'center', marginTop: 0 }}>
          {modoRecuperacao ? 'Recuperar Senha' : 'Acessar Sistema'}
        </h2>
        
        <form onSubmit={modoRecuperacao ? handleRecuperacao : handleLogin} style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
          
          <div>
            <label style={{ display: 'block', fontSize: '13px', color: 'var(--texto-secundario)', marginBottom: '5px' }}>E-mail</label>
            <input 
              type="email" 
              value={email} 
              onChange={(e) => setEmail(e.target.value)} 
              required
              placeholder="seu@email.com"
              style={inputStyle}
            />
          </div>

          {!modoRecuperacao && (
            <div>
              <label style={{ display: 'block', fontSize: '13px', color: 'var(--texto-secundario)', marginBottom: '5px' }}>Senha</label>
              <input 
                type="password" 
                value={password} 
                onChange={(e) => setPassword(e.target.value)} 
                required
                placeholder="******"
                style={inputStyle}
              />
            </div>
          )}

          {mensagem && (
            <div style={{ 
              color: mensagem.tipo === 'erro' ? '#ff5252' : '#00e676', 
              fontSize: '13px', textAlign: 'center', padding: '10px', 
              backgroundColor: mensagem.tipo === 'erro' ? 'rgba(255, 82, 82, 0.1)' : 'rgba(0, 230, 118, 0.1)', 
              borderRadius: '6px', border: `1px solid ${mensagem.tipo === 'erro' ? '#ff5252' : '#00e676'}`
            }}>
              {mensagem.texto}
            </div>
          )}

          <button 
            type="submit" 
            disabled={loading}
            style={{
              padding: '12px', marginTop: '10px',
              backgroundColor: 'var(--destaque)', color: '#fff',
              border: 'none', borderRadius: '8px', cursor: loading ? 'not-allowed' : 'pointer',
              fontWeight: 'bold', fontSize: '15px', opacity: loading ? 0.7 : 1
            }}
          >
            {loading ? 'Processando...' : (modoRecuperacao ? 'Enviar Link' : 'Entrar')}
          </button>
        </form>

        <div style={{ marginTop: '20px', fontSize: '12px', textAlign: 'center', color: 'var(--texto-secundario)', borderTop: '1px solid var(--borda)', paddingTop: '15px' }}>
          {modoRecuperacao ? (
            <p>Lembrou a senha? <span onClick={() => {setModoRecuperacao(false); setMensagem(null)}} style={{color: 'var(--destaque)', cursor: 'pointer', fontWeight: 'bold'}}>Voltar ao login</span></p>
          ) : (
             <p>Esqueceu a senha? <span onClick={() => {setModoRecuperacao(true); setMensagem(null)}} style={{color: 'var(--destaque)', cursor: 'pointer', fontWeight: 'bold'}}>Recuperar agora</span></p>
          )}
        </div>
      </div>
    </div>
  );
}

const inputStyle = { width: '100%', padding: '10px', borderRadius: '6px', border: '1px solid var(--borda)', background: 'var(--input-bg)', color: 'var(--texto-primario)', outline: 'none' };
</file>

<file path="sitema-regulacao/src/ViewerCorpo.jsx">
import React from 'react';

const CorpoHumano = ({ aoSelecionar, parteAtiva, vista = 'frente' }) => {

  // --- CORES & ESTILO ---
  const colors = {
    fill: '#f1f5f9',          // Slate-100 (Fundo suave)
    stroke: '#94a3b8',        // Slate-400 (Contorno neutro)
    fillSelected: '#3b82f6',  // Blue-500 (Selecionado)
    strokeSelected: '#1d4ed8',// Blue-700 (Borda forte)
    hover: '#cbd5e1'          // Slate-300 (Hover)
  };

  // Fun√ß√£o que decide a cor baseada no ID selecionado
  const getStyle = (targetId) => {
    // Verifica se a parte ativa bate com o ID deste elemento
    const isSelected = parteAtiva === targetId;
    
    return {
      fill: isSelected ? colors.fillSelected : colors.fill,
      stroke: isSelected ? colors.strokeSelected : colors.stroke,
      strokeWidth: '2',
      cursor: 'pointer',
      transition: 'all 0.2s ease',
      vectorEffect: 'non-scaling-stroke', // Mant√©m a borda bonita no zoom
    };
  };

  // Componente auxiliar para desenhar uma parte do corpo
  // sqlId = O ID exato que est√° no seu banco de dados
  const BodyPart = ({ sqlId, d }) => (
    <path
      d={d}
      style={getStyle(sqlId)}
      onClick={(e) => {
        e.stopPropagation();
        if (aoSelecionar) aoSelecionar(sqlId);
      }}
      onMouseEnter={(e) => {
        if (parteAtiva !== sqlId) e.target.style.fill = colors.hover;
      }}
      onMouseLeave={(e) => {
        if (parteAtiva !== sqlId) e.target.style.fill = colors.fill;
        else e.target.style.fill = colors.fillSelected;
      }}
    />
  );

  return (
    <div style={{ width: '100%', display: 'flex', justifyContent: 'center' }}>
      <svg 
        viewBox="0 0 300 700" 
        style={{ height: '550px', width: 'auto', maxWidth: '100%' }}
        xmlns="http://www.w3.org/2000/svg"
      >
        {vista === 'frente' ? (
          <g transform="translate(0, 20)">
            {/* --- FRENTE --- */}

            {/* Cabe√ßa & Pesco√ßo */}
            <BodyPart sqlId="cabeca" d="M150,20 C130,20 125,45 125,75 C125,105 135,120 150,120 C165,120 175,105 175,75 C175,45 170,20 150,20 Z" />
            <BodyPart sqlId="pescoco" d="M135,115 L165,115 L165,135 Q150,140 135,135 Z" />

            {/* Tronco (Dividido conforme SQL) */}
            <BodyPart sqlId="peito" d="M125,140 Q150,145 175,140 L180,200 Q150,210 120,200 Z" />
            <BodyPart sqlId="abdomen" d="M120,205 Q150,215 180,205 L175,260 Q150,270 125,260 Z" />
            <BodyPart sqlId="pelvis" d="M125,265 Q150,275 175,265 L185,300 L115,300 L125,265 Z" />

            {/* Bra√ßos (Agrupados: clique no antebra√ßo ou b√≠ceps manda o mesmo ID) */}
            {/* Esquerdo */}
            <BodyPart sqlId="ombro-esquerdo" d="M180,140 L210,150 L200,180 L178,170 Z" />
            <BodyPart sqlId="braco-esquerdo" d="M212,155 L220,200 L200,205 L195,160 Z" /> {/* B√≠ceps */}
            <BodyPart sqlId="braco-esquerdo" d="M220,205 L225,260 L205,265 L200,210 Z" /> {/* Antebra√ßo */}
            <BodyPart sqlId="mao-esquerda" d="M225,265 L235,300 L210,305 L205,270 Z" />

            {/* Direito */}
            <BodyPart sqlId="ombro-direito" d="M120,140 L90,150 L100,180 L122,170 Z" />
            <BodyPart sqlId="braco-direito" d="M88,155 L80,200 L100,205 L105,160 Z" /> {/* B√≠ceps */}
            <BodyPart sqlId="braco-direito" d="M80,205 L75,260 L95,265 L100,210 Z" /> {/* Antebra√ßo */}
            <BodyPart sqlId="mao-direita" d="M75,265 L65,300 L90,305 L95,270 Z" />

            {/* Pernas (Agrupados: Coxa e Canela enviam o mesmo ID) */}
            {/* Esquerda */}
            <BodyPart sqlId="perna-esquerda" d="M155,305 L180,305 L175,400 L150,400 Z" /> {/* Coxa */}
            <BodyPart sqlId="perna-esquerda" d="M152,405 L173,405 L170,500 L155,500 Z" /> {/* Canela */}
            <BodyPart sqlId="pe-esquerdo" d="M155,505 L170,505 L180,530 L150,530 Z" />

            {/* Direita */}
            <BodyPart sqlId="perna-direita" d="M145,305 L120,305 L125,400 L150,400 Z" /> {/* Coxa */}
            <BodyPart sqlId="perna-direita" d="M148,405 L127,405 L130,500 L145,500 Z" /> {/* Canela */}
            <BodyPart sqlId="pe-direito" d="M145,505 L130,505 L120,530 L150,530 Z" />
          </g>
        ) : (
          <g transform="translate(0, 20)">
            {/* --- COSTAS --- */}
            
            {/* Cabe√ßa Costas */}
            <BodyPart sqlId="cabeca" d="M150,20 C130,20 125,45 125,75 C125,105 135,120 150,120 C165,120 175,105 175,75 C175,45 170,20 150,20 Z" />
            <BodyPart sqlId="pescoco" d="M135,115 L165,115 L165,135 Q150,140 135,135 Z" />

            {/* Coluna Vertebral (Dividida conforme SQL) */}
            <BodyPart sqlId="coluna-cervical" d="M140,135 L160,135 L160,165 L140,165 Z" />
            <BodyPart sqlId="coluna-toracica" d="M140,168 L160,168 L160,230 L140,230 Z" />
            <BodyPart sqlId="coluna-lombar" d="M140,233 L160,233 L160,270 L140,270 Z" />

            {/* √Årea das costas (fundo) - N√£o clic√°vel ou parte do ombro */}
            {/* Decidi mapear as laterais das costas para 'Ombro' ou deixar visual. 
                Pelo seu SQL, n√£o tem "Costas Superior". Vou expandir os ombros para preencher as costas. */}
            
            <BodyPart sqlId="ombro-esquerdo" d="M162,135 L210,150 L200,230 L162,230 Z" />
            <BodyPart sqlId="ombro-direito" d="M138,135 L90,150 L100,230 L138,230 Z" />

            {/* Gl√∫teos */}
            <BodyPart sqlId="gluteos" d="M120,275 L180,275 L185,320 L115,320 Z" />

            {/* Membros Costas (Mesma l√≥gica da frente) */}
            {/* Bra√ßo Esquerdo Costas */}
            <BodyPart sqlId="braco-esquerdo" d="M212,155 L220,200 L200,205 L195,160 Z" />
            <BodyPart sqlId="braco-esquerdo" d="M220,205 L225,260 L205,265 L200,210 Z" />
            <BodyPart sqlId="mao-esquerda" d="M225,265 L235,300 L210,305 L205,270 Z" />

            {/* Bra√ßo Direito Costas */}
            <BodyPart sqlId="braco-direito" d="M88,155 L80,200 L100,205 L105,160 Z" />
            <BodyPart sqlId="braco-direito" d="M80,205 L75,260 L95,265 L100,210 Z" />
            <BodyPart sqlId="mao-direita" d="M75,265 L65,300 L90,305 L95,270 Z" />

            {/* Perna Esquerda Costas */}
            <BodyPart sqlId="perna-esquerda" d="M155,325 L180,325 L175,400 L150,400 Z" />
            <BodyPart sqlId="perna-esquerda" d="M152,405 L173,405 L170,500 L155,500 Z" />
            <BodyPart sqlId="pe-esquerdo" d="M155,505 L170,505 L180,530 L150,530 Z" />

            {/* Perna Direita Costas */}
            <BodyPart sqlId="perna-direita" d="M145,325 L120,325 L125,400 L150,400 Z" />
            <BodyPart sqlId="perna-direita" d="M148,405 L127,405 L130,500 L145,500 Z" />
            <BodyPart sqlId="pe-direito" d="M145,505 L130,505 L120,530 L150,530 Z" />

          </g>
        )}
      </svg>
    </div>
  );
};

export default CorpoHumano;
</file>

<file path="README.md">
# üè• SISREG PRO - Sistema de Regula√ß√£o de Protocolos M√©dicos

> Uma plataforma visual e interativa para consulta de protocolos m√©dicos baseada na anatomia humana.

![Status](https://img.shields.io/badge/STATUS-BETA-orange)
![Tech](https://img.shields.io/badge/STACK-REACT_%7C_SUPABASE-blue)
![Security](https://img.shields.io/badge/SECURITY-RLS_ENABLED-green)

## üéØ Sobre o Projeto

O **SISREG PRO** moderniza o acesso a diretrizes de regula√ß√£o m√©dica. Ao inv√©s de buscar em listas intermin√°veis ou PDFs est√°ticos, o regulador utiliza um **Visualizador Anat√¥mico Interativo** para selecionar a regi√£o afetada e encontrar os protocolos corretos (exames necess√°rios, locais de atendimento, crit√©rios de encaminhamento).

O sistema foi projetado com uma arquitetura **Data-Driven**: o Frontend desenha o corpo, mas o Banco de Dados (Supabase) define os nomes, as regras e a estrutura hier√°rquica.

---

## üöÄ Funcionalidades Principais

### üß† Visualizador Anat√¥mico Inteligente
* **Navega√ß√£o Visual:** Modelo SVG interativo com vistas **Frente** e **Costas**.
* **Design Modular:** O corpo √© constru√≠do por blocos geom√©tricos (CSS-in-JS) para clareza visual.
* **Camada "Pele/Geral" (Silhueta):** Uma camada de fundo inteligente permite clicar no contorno do boneco para selecionar protocolos sist√™micos ou dermatol√≥gicos (que n√£o possuem √≥rg√£o espec√≠fico).
* **Mapeamento Din√¢mico:** O SVG possui IDs t√©cnicos (`coxa-direita`), mas o "c√©rebro" do sistema busca o nome real (`Membro Inferior D`) no banco de dados em tempo real.

### üõ°Ô∏è Administra√ß√£o e Seguran√ßa (RBAC)
* **Permiss√µes via Banco de Dados (RLS):**
    * **Visitante:** Acesso negado.
    * **User:** Leitura dos protocolos.
    * **Admin:** Criar/Editar/Excluir protocolos e renomear √°reas.
    * **Super Admin:** Gest√£o de equipe (promover/rebaixar usu√°rios) e auditoria.
* **Live Edit:** Administradores podem renomear partes do corpo e subcategorias clicando diretamente nos t√≠tulos (Inline Editing), sem acessar o painel do banco de dados.

### üîê Autentica√ß√£o Completa
* Login via E-mail/Senha.
* Recupera√ß√£o de Senha (Fluxo completo com link m√°gico e modal de redefini√ß√£o).
* Monitoramento de Usu√°rios Online (Presence).

---

## üõ†Ô∏è Stack Tecnol√≥gica

| √Årea | Tecnologia | Detalhes |
| :--- | :--- | :--- |
| **Frontend** | **React.js (Vite)** | Hooks personalizados, SVG Manipul√°vel. |
| **Estiliza√ß√£o** | **CSS Modules / CSS-in-JS** | Design System limpo e responsivo. |
| **Backend** | **Supabase** | BaaS (Backend as a Service). |
| **Banco de Dados** | **PostgreSQL** | Relacional, com Triggers e Policies. |
| **Seguran√ßa** | **Row Level Security (RLS)** | A seguran√ßa √© aplicada na query do banco. |
| **Deploy** | **Vercel** | Integra√ß√£o cont√≠nua (CI/CD). |

---

## üß© Arquitetura do Boneco (Destaque T√©cnico)

O componente `CorpoHumano.jsx` n√£o √© apenas um desenho. Ele funciona em camadas:

1.  **Camada 0 (Silhueta):** Desenha o corpo inteiro com uma borda grossa (`strokeWidth: 12`) e cor de pele. Como os vetores se sobrep√µem e t√™m a mesma cor, eles criam uma silhueta perfeita para representar "Pele/Geral".
2.  **Camada 1 (M√≥dulos):** Desenha os blocos (t√≥rax, membros) por cima.
3.  **O "C√©rebro" (Mapper):**
    ```javascript
    // Exemplo de como o React traduz o clique
    const resolverAcao = (sqlIdOriginal) => {
       // O SVG diz: "cliquei em coxa-direita"
       // O Mapa diz: "coxa-direita" = "Protocolo de F√™mur"
       return mapaDeNomes[sqlIdOriginal] || sqlIdOriginal;
    };
    ```

---

## üíæ Instala√ß√£o e Execu√ß√£o

### Pr√©-requisitos
* Node.js instalado.
* Conta no Supabase.

### 1. Clonar o reposit√≥rio
```bash
git clone [https://github.com/seu-usuario/sisreg-pro.git](https://github.com/seu-usuario/sisreg-pro.git)
cd sisreg-pro

2. Instalar depend√™ncias
Bash
npm install

3. Configurar Vari√°veis de Ambiente
Crie um arquivo .env na raiz:

Snippet de c√≥digo
VITE_SUPABASE_URL=sua_url_do_supabase
VITE_SUPABASE_ANON_KEY=sua_key_anonima

4. Configurar o Banco de Dados
Execute o script SQL contido em src/database_schema.sql no Editor SQL do seu projeto Supabase para criar as tabelas (body_parts, protocols, sub_areas) e as pol√≠ticas de seguran√ßa.

N√£o esque√ßa de rodar os INSERTS iniciais das partes do corpo!

5. Rodar o projeto
Bash
npm run dev

Vis√£o Frontal,Vis√£o Costas,Modo Edi√ß√£o (Admin)
[<img width="1596" height="754" alt="image" src="https://github.com/user-attachments/assets/cac3f30d-70b2-45ba-8ac3-747650790c6c" />
],[<img width="1599" height="766" alt="image" src="https://github.com/user-attachments/assets/bd9b1c6e-e606-48b6-9f51-a304f6206ea3" />
],[<img width="1590" height="763" alt="image" src="https://github.com/user-attachments/assets/1ad398c6-b660-40ba-bde9-07c8af30fb59" />
]

üìÑ Licen√ßa
Este projeto est√° sob a licen√ßa MIT. Sinta-se livre para usar e modificar.

Desenvolvido com üíô e React.
</file>

<file path="sitema-regulacao/src/App.jsx">
import React, { useState, useEffect } from 'react';
import CorpoHumano from './CorpoHumano';
import { supabase } from './supabaseClient';
import Login from './Login';
import ModalForm from './ModalForm';
import Toast from './Toast';
import './App.css'; 
import HeaderSecao from './HeaderSecao';
import NovaSenha from './NovaSenha'; // <--- IMPORT NOVO

function App() {
  // --- ESTADOS GERAIS ---
  const [darkMode, setDarkMode] = useState(true);
  const [parteSelecionada, setParteSelecionada] = useState(null);
  const [subAreaSelecionada, setSubAreaSelecionada] = useState(null);
  const [vista, setVista] = useState('frente');
  const [modoEdicao, setModoEdicao] = useState(false);
  const [loading, setLoading] = useState(false);
  
  // DADOS DO BANCO & C√âREBRO (MAPA)
  const [subMenus, setSubMenus] = useState([]);
  const [listaProtocolos, setListaProtocolos] = useState([]);
  const [mapaPartes, setMapaPartes] = useState({}); 

  // MODAL, NOTIFICA√á√ïES E RECUPERA√á√ÉO
  const [modalAberto, setModalAberto] = useState(false);
  const [itemEmEdicao, setItemEmEdicao] = useState(null);
  const [toast, setToast] = useState(null);
  const [mostraNovaSenha, setMostraNovaSenha] = useState(false); // <--- ESTADO NOVO

  // BUSCA E LOGIN
  const [termoBusca, setTermoBusca] = useState('');
  const [resultadosBusca, setResultadosBusca] = useState([]);
  const [buscando, setBuscando] = useState(false);
  const [sessao, setSessao] = useState(null);
  const [mostrarLogin, setMostrarLogin] = useState(false);
  
  // --- PERMISS√ïES E ONLINE CHECKER ---
  const [isAdmin, setIsAdmin] = useState(false);          
  const [isSuperAdmin, setIsSuperAdmin] = useState(false); 
  const [meuPerfil, setMeuPerfil] = useState(null);
  const [usuariosOnline, setUsuariosOnline] = useState([]);
  const [mostrarListaOnline, setMostrarListaOnline] = useState(false);
  const [modalUsuariosAberto, setModalUsuariosAberto] = useState(false);
  const [listaUsuarios, setListaUsuarios] = useState([]);

  // --- EFEITOS (Dark Mode e Auth) ---
  useEffect(() => {
    if (darkMode) document.body.classList.add('dark-mode');
    else document.body.classList.remove('dark-mode');
  }, [darkMode]);

  // --- AUTENTICA√á√ÉO E RECUPERA√á√ÉO DE SENHA ---
  useEffect(() => {
    // 1. Pega sess√£o inicial
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSessao(session);
      if (session) carregarPerfilUsuario(session.user.id);
    });

    // 2. Escuta mudan√ßas (Login, Logout, RECUPERA√á√ÉO)
    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
      setSessao(session);

      // SE O USU√ÅRIO CLICOU NO LINK DE EMAIL DE RECUPERA√á√ÉO:
      if (event === 'PASSWORD_RECOVERY') {
        setMostraNovaSenha(true);
      }

      if (session) {
        carregarPerfilUsuario(session.user.id);
        setMostrarLogin(false);
      } else {
        setIsAdmin(false);
        setIsSuperAdmin(false);
        setMeuPerfil(null);
        setModoEdicao(false);
        setParteSelecionada(null);
        setUsuariosOnline([]);
      }
    });
    return () => subscription.unsubscribe();
  }, []);

  // --- CARREGA O MAPA DE NOMES (C√âREBRO) ---
  useEffect(() => {
    async function fetchBodyParts() {
      const { data } = await supabase.from('body_parts').select('id, display_name');
      if (data) {
        const mapa = {};
        data.forEach(part => {
          mapa[part.id] = { label: part.display_name, id: part.id };
        });
        setMapaPartes(mapa);
      }
    }
    fetchBodyParts();
  }, []);

  async function carregarPerfilUsuario(userId) {
    const { data } = await supabase.from('profiles').select('role, nickname').eq('id', userId).single();
    if (data) {
      setMeuPerfil(data);
      const ehSuper = data.role === 'super_admin';
      setIsAdmin(data.role === 'admin' || ehSuper);
      setIsSuperAdmin(ehSuper);
    }
  }

  // --- ONLINE CHECKER ---
  useEffect(() => {
    if (!sessao?.user || !meuPerfil) return;
    const channel = supabase.channel('sala-global', { config: { presence: { key: sessao.user.id } } });
    channel
      .on('presence', { event: 'sync' }, () => {
        const newState = channel.presenceState();
        const listaTemporaria = [];
        for (let key in newState) {
          const usuario = newState[key][0];
          if (usuario) listaTemporaria.push(usuario);
        }
        const unicos = listaTemporaria.filter((v,i,a)=>a.findIndex(v2=>(v2.userId===v.userId))===i);
        setUsuariosOnline(unicos);
      })
      .subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
          await channel.track({
            userId: sessao.user.id,
            label: meuPerfil.nickname || sessao.user.email,
            entrou_em: new Date().toISOString()
          });
        }
      });
    return () => { supabase.removeChannel(channel); };
  }, [sessao, meuPerfil]);

  // --- CARREGAMENTO DE DADOS DA PARTE ---
  useEffect(() => {
    if (parteSelecionada) {
      setTermoBusca('');
      setSubAreaSelecionada(null); 
      carregarDadosDaParte(parteSelecionada);
    }
  }, [parteSelecionada]);

  async function carregarDadosDaParte(idParte) {
    setLoading(true);
    const { data: subs } = await supabase.from('sub_areas').select('*').eq('body_part_id', idParte).order('name');
    setSubMenus(subs || []);
    if (subs && subs.length > 0) setSubAreaSelecionada(subs[0].id);
    else setSubAreaSelecionada(null);

    const { data: protos } = await supabase.from('protocols').select('*').eq('body_part_id', idParte).order('created_at', { ascending: false });
    setListaProtocolos(protos || []);
    setLoading(false);
  }

  const protocolosVisiveis = subAreaSelecionada ? listaProtocolos.filter(p => p.sub_area_id === subAreaSelecionada) : []; 

  // --- FUN√á√ïES DE RENOMEAR (LIVE EDIT) ---
  const renomearParte = async (novoNome) => {
    if (!isAdmin || !parteSelecionada) return;
    const { error } = await supabase.from('body_parts').update({ display_name: novoNome }).eq('id', parteSelecionada);
    if (!error) {
      setToast({ mensagem: 'Nome atualizado!', tipo: 'sucesso' });
      // Atualiza o mapa localmente
      setMapaPartes(prev => ({
        ...prev,
        [parteSelecionada]: { ...prev[parteSelecionada], label: novoNome }
      }));
    } else {
      setToast({ mensagem: 'Erro ao renomear.', tipo: 'erro' });
    }
  };

  const renomearSubArea = async (idSub, nomeAtual) => {
    if (!isAdmin || !modoEdicao) return;
    const novoNome = window.prompt("Novo nome para a categoria:", nomeAtual);
    if (novoNome && novoNome !== nomeAtual) {
      const { error } = await supabase.from('sub_areas').update({ name: novoNome }).eq('id', idSub);
      if (!error) {
        setToast({ mensagem: 'Categoria renomeada!', tipo: 'sucesso' });
        carregarDadosDaParte(parteSelecionada);
      }
    }
  };

  // --- BUSCA GLOBAL ---
  useEffect(() => {
    const delayDebounce = setTimeout(() => {
      if (termoBusca.length > 2) realizarBusca(termoBusca);
      else setResultadosBusca([]);
    }, 500);
    return () => clearTimeout(delayDebounce);
  }, [termoBusca]);

  async function realizarBusca(texto) {
    setBuscando(true);
    setParteSelecionada(null);
    const { data, error } = await supabase.from('protocols').select('*, body_parts(display_name)')
      .or(`problema.ilike.%${texto}%,locais.ilike.%${texto}%,exame.ilike.%${texto}%,informacoes.ilike.%${texto}%`).limit(20);
     
    if (error) {
       const { data: dataBackup } = await supabase.from('protocols').select('*')
        .or(`problema.ilike.%${texto}%,locais.ilike.%${texto}%,exame.ilike.%${texto}%`).limit(20);
       setResultadosBusca(dataBackup || []);
    } else {
      setResultadosBusca(data || []);
    }
    setBuscando(false);
  }

  // --- CRUD GERAL ---
  const abrirModalCriar = () => { 
    if (!parteSelecionada || !isAdmin) return;
    if (!subAreaSelecionada) { alert("‚ö†Ô∏è Crie uma sub-categoria antes."); return; }
    setItemEmEdicao(null); setModalAberto(true); 
  };
  
  const abrirModalEditar = (item) => { if (!isAdmin) return; setItemEmEdicao(item); setModalAberto(true); };

  const salvarDadosDoModal = async (dados) => {
    setModalAberto(false);
    try {
      if (itemEmEdicao) {
        const { error } = await supabase.from('protocols').update({ problema: dados.problema, locais: dados.locais, informacoes: dados.informacoes, exame: dados.exame }).eq('id', itemEmEdicao.id);
        if (error) throw error;
        setToast({ mensagem: 'Atualizado!', tipo: 'sucesso' });
      } else {
        const { error } = await supabase.from('protocols').insert([{ body_part_id: parteSelecionada, sub_area_id: subAreaSelecionada, problema: dados.problema, locais: dados.locais, informacoes: dados.informacoes, exame: dados.exame || "Consulta" }]);
        if (error) throw error;
        setToast({ mensagem: 'Adicionado!', tipo: 'sucesso' });
      }
      if (parteSelecionada) carregarDadosDaParte(parteSelecionada);
      if (termoBusca) realizarBusca(termoBusca);
    } catch (e) { setToast({ mensagem: 'Erro ao salvar.', tipo: 'erro' }); }
  };

  const remover = async (id, origem = 'lista') => {
    if (!isAdmin || !window.confirm("Apagar item?")) return;
    const { error } = await supabase.from('protocols').delete().eq('id', id);
    if (!error) {
      setToast({ mensagem: 'Removido.', tipo: 'sucesso' });
      if (origem === 'busca') setResultadosBusca(prev => prev.filter(item => item.id !== id));
      else carregarDadosDaParte(parteSelecionada);
    }
  };

  const apagarSubMenu = async (idSub, nomeSub) => {
    if (!isAdmin || !modoEdicao) return;
    if (window.confirm(`Excluir categoria "${nomeSub}"?`)) {
      const { error } = await supabase.from('sub_areas').delete().eq('id', idSub);
      if (!error) { if (subAreaSelecionada === idSub) setSubAreaSelecionada(null); carregarDadosDaParte(parteSelecionada); }
    }
  };

  // --- SUPER ADMIN ---
  const abrirModalUsuarios = async () => {
    if (!isSuperAdmin) return;
    setModalUsuariosAberto(true);
    const { data } = await supabase.from('profiles').select('*').order('email');
    setListaUsuarios(data || []);
  };

  const alterarCargo = async (idUsuario, novoCargo) => {
    if (!window.confirm(`Mudar cargo para ${novoCargo.toUpperCase()}?`)) return;
    const { error } = await supabase.from('profiles').update({ role: novoCargo }).eq('id', idUsuario);
    if (!error) {
      setToast({ mensagem: 'Cargo atualizado!', tipo: 'sucesso' });
      const { data } = await supabase.from('profiles').select('*').order('email');
      setListaUsuarios(data || []);
    }
  };

  const editarNickname = async (idUsuario, nicknameAtual) => {
    const novoNick = window.prompt("Digite o novo Nickname (deixe vazio para usar o email):", nicknameAtual || "");
    if (novoNick === null) return; 

    const { error } = await supabase.from('profiles').update({ nickname: novoNick || null }).eq('id', idUsuario);
    if (!error) {
      setToast({ mensagem: 'Nickname atualizado!', tipo: 'sucesso' });
      if (idUsuario === sessao.user.id) setMeuPerfil(prev => ({ ...prev, nickname: novoNick || null }));
      const { data } = await supabase.from('profiles').select('*').order('email');
      setListaUsuarios(data || []);
    } else {
      alert("Erro ao mudar nickname.");
    }
  };

  // --- RENDERIZA√á√ÉO ---
  return (
    <div style={{ display: 'flex', flexDirection: 'column', height: '100vh' }}>
      
      {/* MODAIS GERAIS */}
      {mostrarLogin && <Login aoFechar={() => setMostrarLogin(false)} />}
      <ModalForm isOpen={modalAberto} onClose={() => setModalAberto(false)} onSave={salvarDadosDoModal} itemEdicao={itemEmEdicao} />
      {toast && <Toast mensagem={toast.mensagem} tipo={toast.tipo} onClose={() => setToast(null)} />}
      
      {/* MODAL DE NOVA SENHA (ATIVADO PELO E-MAIL) */}
      {mostraNovaSenha && <NovaSenha aoFinalizar={() => setMostraNovaSenha(false)} />}

      {/* LISTA ONLINE */}
      {mostrarListaOnline && (
        <div style={{
          position: 'absolute', top: '70px', right: '100px', width: '250px', backgroundColor: 'var(--bg-card)', 
          border: '1px solid var(--destaque)', borderRadius: '8px', boxShadow: '0 4px 15px rgba(0,0,0,0.3)', zIndex: 3000, padding: '10px'
        }}>
          <div style={{fontSize:'12px', fontWeight:'bold', color:'var(--texto-secundario)', marginBottom:'8px', display:'flex', justifyContent:'space-between'}}>
            <span>USU√ÅRIOS ONLINE ({usuariosOnline.length})</span>
            <span style={{cursor:'pointer'}} onClick={()=>setMostrarListaOnline(false)}>‚úñ</span>
          </div>
          <div style={{maxHeight:'200px', overflowY:'auto'}}>
            {usuariosOnline.map((user, idx) => (
               <div key={idx} style={{display:'flex', alignItems:'center', gap:'8px', padding:'5px 0', borderBottom:'1px solid var(--borda)'}}>
                 <div style={{width:'8px', height:'8px', borderRadius:'50%', background:'#00e676', boxShadow:'0 0 5px #00e676'}}></div>
                 <span style={{fontSize:'12px', color:'var(--texto-primario)'}}>
                   {user.userId === sessao?.user?.id ? 'Voc√™' : (user.label.includes('@') ? user.label.split('@')[0] : user.label)}
                 </span>
               </div>
            ))}
          </div>
        </div>
      )}

      {/* MODAL GEST√ÉO EQUIPE */}
      {modalUsuariosAberto && (
        <div style={{ position: 'fixed', top: 0, left: 0, width: '100%', height: '100%', backgroundColor: 'rgba(0,0,0,0.8)', zIndex: 2000, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
          <div style={{ backgroundColor: 'var(--bg-card)', padding: '20px', borderRadius: '10px', width: '90%', maxWidth: '700px', maxHeight: '80vh', overflowY: 'auto', border: '1px solid var(--destaque)' }}>
            <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'20px' }}>
              <h2 style={{ margin: 0, color: 'var(--destaque)' }}>Gest√£o da Equipe</h2>
              <button onClick={() => setModalUsuariosAberto(false)} style={{ background: 'none', border: 'none', color: 'var(--texto-primario)', fontSize: '20px', cursor: 'pointer' }}>‚úï</button>
            </div>
            <table style={{ width: '100%', borderCollapse: 'collapse', color: 'var(--texto-primario)' }}>
              <thead><tr style={{ borderBottom: '1px solid var(--borda)', textAlign: 'left' }}><th style={{ padding: '10px' }}>Usu√°rio / Nickname</th><th style={{ padding: '10px' }}>Cargo</th><th style={{ padding: '10px', textAlign: 'right' }}>A√ß√£o</th></tr></thead>
              <tbody>
                {listaUsuarios.map(u => (
                  <tr key={u.id} style={{ borderBottom: '1px solid var(--borda)' }}>
                    <td style={{ padding: '10px', fontSize:'14px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <div>
                           <div style={{ fontWeight: 'bold' }}>{u.nickname || u.email} {u.role === 'super_admin' && 'üëë'}</div>
                           {u.nickname && <div style={{ fontSize: '10px', color: 'var(--texto-secundario)' }}>{u.email}</div>}
                        </div>
                        <button onClick={() => editarNickname(u.id, u.nickname)} title="Editar Apelido" style={{ border: 'none', background: 'transparent', cursor: 'pointer', fontSize: '14px' }}>‚úèÔ∏è</button>
                      </div>
                    </td>
                    <td style={{ padding: '10px' }}><span style={{ padding: '2px 8px', borderRadius: '4px', fontSize: '12px', fontWeight: 'bold', backgroundColor: u.role === 'admin' || u.role === 'super_admin' ? 'rgba(0, 255, 0, 0.1)' : 'rgba(128, 128, 128, 0.1)', color: u.role === 'admin' || u.role === 'super_admin' ? 'var(--destaque)' : 'var(--texto-secundario)' }}>{u.role ? u.role.toUpperCase() : 'USER'}</span></td>
                    <td style={{ padding: '10px', textAlign: 'right' }}>
                      {u.role !== 'super_admin' && (u.role === 'admin' ? 
                        <button onClick={() => alterarCargo(u.id, 'user')} style={{ padding: '4px 8px', fontSize: '12px', background: '#ff5252', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>Rebaixar</button> : 
                        <button onClick={() => alterarCargo(u.id, 'admin')} style={{ padding: '4px 8px', fontSize: '12px', background: 'var(--destaque)', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>Promover</button>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* HEADER PRINCIPAL */}
      <header style={{ height: '70px', padding: '0 20px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', backgroundColor: 'var(--bg-card)', borderBottom: '1px solid var(--borda)', flexShrink: 0 }}>
        <div style={{ fontWeight: 'bold', fontSize: '18px', color: 'var(--destaque)' }}>SISREG<span style={{ fontSize: '10px', opacity: 0.7 }}>PRO</span></div>
        
        {sessao && (
          <div style={{ flex: 1, maxWidth: '400px', margin: '0 20px', position: 'relative' }}>
            <span style={{position:'absolute', left:'10px', top:'50%', transform:'translateY(-50%)'}}>üîç</span>
            <input type="text" placeholder="Pesquisar..." value={termoBusca} onChange={(e) => setTermoBusca(e.target.value)} style={{ width: '100%', padding: '8px 15px 8px 35px', borderRadius: '20px', border: '1px solid var(--borda)', background: 'var(--input-bg)', color: 'var(--texto-primario)', outline: 'none' }} />
            {termoBusca && <button onClick={() => setTermoBusca('')} style={{position:'absolute', right:'10px', top:'50%', transform:'translateY(-50%)', border:'none', background:'transparent', cursor:'pointer', color:'var(--texto-secundario)'}}>‚úñ</button>}
          </div>
        )}

        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
          {sessao && (
            <button onClick={() => setMostrarListaOnline(!mostrarListaOnline)} style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', borderRadius: '20px', border: '1px solid #00e676', backgroundColor: 'rgba(0, 230, 118, 0.1)', cursor: 'pointer', fontSize: '12px', fontWeight: 'bold', color: '#00e676' }}>
              <div style={{width:'8px', height:'8px', borderRadius:'50%', background:'#00e676', boxShadow:'0 0 5px #00e676'}}></div>
              {usuariosOnline.length} ON
            </button>
          )}

          {sessao?.user?.email && (
            <div style={{ textAlign: 'right', fontSize: '12px' }}>
              <span style={{ color: 'var(--texto-secundario)' }}>Ol√°, </span>
              <span style={{ color: isSuperAdmin ? '#FFD700' : 'var(--destaque)', fontWeight: 'bold' }}>{meuPerfil?.nickname || sessao.user.email} {isSuperAdmin && 'üëë'}</span>
            </div>
          )}

          <button onClick={() => setDarkMode(!darkMode)} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer' }}>{darkMode ? '‚òÄÔ∏è' : 'üåô'}</button>
          {!sessao ? (
            <button onClick={() => setMostrarLogin(true)} style={{ padding: '6px 16px', borderRadius: '20px', border: '1px solid var(--destaque)', color: 'var(--destaque)', background: 'transparent', cursor: 'pointer', fontWeight: 'bold' }}>Entrar</button>
          ) : (
            <>
              {isSuperAdmin && <button onClick={abrirModalUsuarios} style={{ padding: '6px 12px', borderRadius: '20px', border: '1px solid #FFD700', color: '#FFD700', background: 'transparent', cursor: 'pointer', fontWeight: 'bold', fontSize: '11px', display: 'flex', alignItems: 'center', gap: '5px' }}>üë• Equipe</button>}
              {isAdmin && <button onClick={() => setModoEdicao(!modoEdicao)} style={{ padding: '6px 12px', borderRadius: '20px', border: `1px solid ${modoEdicao ? '#ff5252' : 'var(--borda)'}`, color: modoEdicao ? '#ff5252' : 'var(--texto-secundario)', background: 'transparent', cursor: 'pointer', fontWeight: 'bold', fontSize: '11px' }}>{modoEdicao ? 'üîì EDITANDO' : 'üîí ADMIN'}</button>}
              <button onClick={() => supabase.auth.signOut()} style={{ fontSize: '12px', color: 'var(--texto-secundario)', background:'none', border:'none', cursor:'pointer', textDecoration: 'underline' }}>Sair</button>
            </>
          )}
        </div>
      </header>

      {/* CONTE√öDO PRINCIPAL */}
      <main style={{ flex: 1, display: 'flex', overflow: 'hidden', position: 'relative' }}>
        {!sessao ? (
          <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', backgroundColor: 'var(--bg-pagina)', color: 'var(--texto-primario)', textAlign: 'center', padding: '20px' }}>
            <div style={{ fontSize: '60px', marginBottom: '20px' }}>üîí</div>
            <h1 style={{ color: 'var(--destaque)' }}>Acesso Restrito</h1>
            <p style={{ maxWidth: '400px', lineHeight: '1.6', color: 'var(--texto-secundario)', marginBottom: '30px' }}>Fa√ßa login para acessar o sistema.</p>
            <button onClick={() => setMostrarLogin(true)} style={{ padding: '12px 30px', fontSize: '16px', backgroundColor: 'var(--destaque)', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer' }}>Fazer Login</button>
          </div>
        ) : (
          <>
            {/* PAINEL ESQUERDO: BONECO */}
            <section style={{ flex: 1, position: 'relative', borderRight: '1px solid var(--borda)', display:'flex', alignItems:'center', justifyContent:'center' }}>
              <button onClick={() => { setVista(v => v === 'frente' ? 'costas' : 'frente'); setParteSelecionada(null); }} style={{ position: 'absolute', top: 20, left: 20, zIndex: 10, padding: '8px', borderRadius: '8px', border: '1px solid var(--borda)', background: 'var(--bg-card)', color: 'var(--texto-primario)', cursor: 'pointer' }}>üîÑ {vista.toUpperCase()}</button>
              <div style={{ height: '90%', width: '100%', maxWidth: '350px' }}>
                 <CorpoHumano 
                   aoSelecionar={(info) => setParteSelecionada(info.id || info)} 
                   parteAtiva={parteSelecionada} 
                   vista={vista}
                   mapaDeNomes={mapaPartes} 
                 />
              </div>
            </section>
            
            {/* PAINEL DIREITO: CONTE√öDO */}
            <section style={{ flex: 1.3, padding: '30px', backgroundColor: 'var(--bg-card)', overflowY: 'auto' }}>
              {termoBusca.length > 0 ? (
                <div style={{ animation: 'fadeIn 0.3s' }}>
                  <h2 style={{ color: 'var(--destaque)', margin: 0 }}>Busca Global</h2>
                  <hr style={{ borderColor: 'var(--borda)', opacity: 0.3, margin: '20px 0' }} />
                  {!buscando && resultadosBusca.length > 0 ? (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>{resultadosBusca.map((item) => <CardProtocolo key={item.id} item={item} isAdmin={isAdmin} modoEdicao={modoEdicao} onEdit={abrirModalEditar} onRemove={(id) => remover(id, 'busca')} showTag={true} />)}</div>
                  ) : <p>Nada encontrado.</p>}
                </div>
              ) : (
                parteSelecionada ? (
                  <div style={{ animation: 'fadeIn 0.3s' }}>
                    
                    {/* HEADER SE√á√ÉO COM RENAME */}
                    <HeaderSecao 
                      parteSelecionada={parteSelecionada}
                      nomeAtual={mapaPartes[parteSelecionada]?.label || parteSelecionada} 
                      isAdmin={isAdmin} 
                      modoEdicao={modoEdicao} 
                      aoAbrirModalProtocolo={abrirModalCriar} 
                      aoAtualizar={() => carregarDadosDaParte(parteSelecionada)}
                      onRename={renomearParte} 
                    />

                    {/* SUB-MENUS */}
                    {subMenus.length > 0 ? (
                      <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap', margin: '20px 0', alignItems: 'flex-start' }}>
                        {subMenus.map(sub => (
                          <div key={sub.id} style={{ position: 'relative' }}>
                            <button onClick={() => setSubAreaSelecionada(sub.id)} style={{ padding: '6px 12px', borderRadius: '15px', border: '1px solid var(--destaque)', cursor: 'pointer', fontSize: '13px', background: subAreaSelecionada === sub.id ? 'var(--destaque)' : 'transparent', color: subAreaSelecionada === sub.id ? '#fff' : 'var(--destaque)' }}>{sub.name}</button>
                            {modoEdicao && isAdmin && (
                              <>
                                <button onClick={(e) => { e.stopPropagation(); apagarSubMenu(sub.id, sub.name); }} style={{ position: 'absolute', top: '-8px', right: '-8px', width: '20px', height: '20px', borderRadius: '50%', backgroundColor: '#ff5252', color: 'white', border: 'none', fontSize: '10px', fontWeight: 'bold', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', boxShadow: '0 2px 4px rgba(0,0,0,0.2)', zIndex: 5 }}>X</button>
                                <button onClick={(e) => { e.stopPropagation(); renomearSubArea(sub.id, sub.name); }} style={{ position: 'absolute', top: '-8px', right: '15px', width: '20px', height: '20px', borderRadius: '50%', backgroundColor: '#2196F3', color: 'white', border: 'none', fontSize: '10px', fontWeight: 'bold', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', boxShadow: '0 2px 4px rgba(0,0,0,0.2)', zIndex: 5 }} title="Renomear">‚úé</button>
                              </>
                            )}
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div style={{ padding: '15px', background: 'rgba(255, 165, 0, 0.1)', borderRadius: '8px', margin: '20px 0', color: 'orange', fontSize: '13px' }}>‚ö†Ô∏è Crie uma categoria clicando no <strong>+</strong> acima.</div>
                    )}
                    <hr style={{ borderColor: 'var(--borda)', opacity: 0.3, margin: '20px 0' }} />
                    {loading && <p>Carregando...</p>}
                    {!loading && protocolosVisiveis.length > 0 ? (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>{protocolosVisiveis.map((item) => <CardProtocolo key={item.id} item={item} isAdmin={isAdmin} modoEdicao={modoEdicao} onEdit={abrirModalEditar} onRemove={remover} />)}</div>
                    ) : (
                      !loading && subMenus.length > 0 && <div style={{textAlign:'center', color:'var(--texto-secundario)', padding:'20px', border:'2px dashed var(--borda)', borderRadius:'10px'}}><p>Nenhum protocolo nesta se√ß√£o.</p></div>
                    )}
                  </div>
                ) : <div style={{ height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', opacity: 0.4 }}><span style={{ fontSize: '40px' }}>üëà</span><h3>Selecione uma √°rea</h3></div>
              )}
            </section>
          </>
        )}
      </main>
    </div>
  );
}

const CardProtocolo = ({ item, isAdmin, modoEdicao, onEdit, onRemove, showTag }) => {
  const renderLocais = (texto) => texto ? texto.split('/').map((p, i, a) => <span key={i}>{p.trim()}{i < a.length - 1 && <span style={{ color: 'var(--destaque)', fontWeight: 'bold', margin: '0 6px' }}>/</span>}</span>) : null;
  return (
    <div style={{ padding: '15px', borderRadius: '8px', backgroundColor: 'var(--bg-pagina)', borderLeft: '4px solid var(--destaque)', position: 'relative', boxShadow: '0 2px 5px rgba(0,0,0,0.05)' }}>
      {showTag && item.body_parts && <span style={{ fontSize:'10px', textTransform:'uppercase', background:'var(--destaque)', color:'#fff', padding:'2px 6px', borderRadius:'4px', marginBottom:'5px', display:'inline-block' }}>{item.body_parts.display_name}</span>}
      <h4 style={{ margin: '0 0 8px 0', color: 'var(--texto-primario)', fontSize: '16px' }}>{item.problema}</h4>
      <div style={{ fontSize: '13px', color: 'var(--texto-secundario)', display:'flex', flexDirection:'column', gap:'8px' }}>
        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '6px' }}><span style={{ fontSize: '14px', lineHeight: '1.2' }}>üè•</span><div style={{ flex: 1 }}><strong style={{color:'var(--texto-primario)'}}>Local:</strong> {renderLocais(item.locais)}</div></div>
        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '6px' }}><span style={{ fontSize: '14px', lineHeight: '1.2' }}>üìã</span><div style={{ flex: 1 }}><strong style={{color:'var(--texto-primario)'}}>Exame:</strong> {item.exame}</div></div>
        {item.informacoes && <div style={{ marginTop: '5px', background: 'rgba(128,128,128,0.1)', padding: '10px', borderRadius: '6px', borderLeft: '3px solid var(--texto-secundario)', display: 'flex', alignItems: 'flex-start', gap: '8px' }}><span style={{ fontSize: '14px', lineHeight: '1.4' }}>‚ÑπÔ∏è</span><span style={{ flex: 1, color: 'var(--texto-primario)', whiteSpace: 'pre-wrap', wordBreak: 'break-word', lineHeight: '1.4' }}><strong>Info:</strong> {item.informacoes}</span></div>}
      </div>
      {modoEdicao && isAdmin && <div style={{ position: 'absolute', top: 10, right: 10, display: 'flex', gap: '5px' }}><button onClick={() => onEdit(item)} style={{ border: '1px solid var(--destaque)', color: 'var(--destaque)', background: 'transparent', borderRadius: '4px', cursor: 'pointer', fontSize: '10px', padding: '2px 8px', fontWeight: 'bold' }}>Editar</button><button onClick={() => onRemove(item.id)} style={{ border: '1px solid #ff5252', color: '#ff5252', background: 'transparent', borderRadius: '4px', cursor: 'pointer', fontSize: '10px', padding: '2px 8px' }}>X</button></div>}
    </div>
  );
};

export default App;
</file>

<file path="sitema-regulacao/src/CorpoHumano.jsx">
import React from 'react';

const CorpoHumano = ({ aoSelecionar, parteAtiva, vista = 'frente', mapaDeNomes = {} }) => {

  // --- CORES --- /// 
  const colors = {
    // Camada da Frente (Normal)
    fill: '#f8fafc',
    stroke: '#64748b',
    fillSelected: '#3b82f6',
    strokeSelected: '#1d4ed8',
    hover: '#e2e8f0',

    // Camada de Tr√°s (Pele/Geral) - Tom p√™ssego/pele
    skinBase: '#ffccbc',      // Cor normal da "aura" de pele
    skinSelected: '#ff7043',  // Cor quando a pele geral est√° selecionada
  };

  // --- FUN√á√ïES AUXILIARES ---

  // Resolve o nome bonito baseado no ID
  const getNomeLegivel = (id) => mapaDeNomes[id]?.label || id;

  // Lida com o clique. Se for layer de pele, for√ßa o ID 'pele-geral'
  const handleAction = (e, sqlId, isSkinLayer) => {
    e.stopPropagation();
    const targetId = isSkinLayer ? 'pele-geral' : sqlId;

    const valorFinal = mapaDeNomes[targetId] ? mapaDeNomes[targetId] : targetId;
    if (aoSelecionar) aoSelecionar(valorFinal);
  };

  // --- GERADOR DE ESTILOS (O SEGREDO EST√Å AQUI) ---
  const getStyle = (targetId, isSkinLayer) => {
    // --> ESTILO DA CAMADA DE PELE (FUNDO)
    if (isSkinLayer) {
      const isSkinActive = parteAtiva === 'pele-geral' || (parteAtiva && parteAtiva.id === 'pele-geral');
      const color = isSkinActive ? colors.skinSelected : colors.skinBase;

      return {
        fill: color,           // Preenchimento s√≥lido
        stroke: color,         // Borda da MESMA cor
        strokeWidth: '12',     // Borda GROSSA para criar a "aura" externa
        cursor: 'pointer',
        transition: 'all 0.3s ease',
        strokeLinejoin: 'round', // Cantos arredondados na jun√ß√£o
        strokeLinecap: 'round',
        opacity: isSkinActive ? 1 : 0.6 // Um pouco transparente se n√£o selecionado
      };
    }

    // --> ESTILO DA CAMADA NORMAL (FRENTE)
    const isSelected = parteAtiva === targetId;
    return {
      fill: isSelected ? colors.fillSelected : colors.fill,
      stroke: isSelected ? colors.strokeSelected : colors.stroke,
      strokeWidth: isSelected ? '2.5' : '2',
      cursor: 'pointer',
      transition: 'all 0.2s ease',
      vectorEffect: 'non-scaling-stroke',
    };
  };


  // --- COMPONENTES DE FORMA (Reutiliz√°veis para as duas camadas) ---

  const Block = ({ sqlId, x, y, w, h, radius = 6, isSkinLayer = false }) => (
    <rect
      x={x} y={y} width={w} height={h} rx={radius} ry={radius}
      style={getStyle(sqlId, isSkinLayer)}
      onClick={(e) => handleAction(e, sqlId, isSkinLayer)}
      // Hover s√≥ aplica na camada da frente para n√£o bugar a de tr√°s
      onMouseEnter={!isSkinLayer ? (e) => { if (parteAtiva !== sqlId) e.target.style.fill = colors.hover; } : undefined}
      onMouseLeave={!isSkinLayer ? (e) => { if (parteAtiva !== sqlId) e.target.style.fill = colors.fill; else e.target.style.fill = colors.fillSelected; } : undefined}
    >
      <title>{getNomeLegivel(isSkinLayer ? 'pele-geral' : sqlId)}</title>
    </rect>
  );

  const Round = ({ sqlId, cx, cy, r, isSkinLayer = false }) => (
    <circle
      cx={cx} cy={cy} r={r}
      style={getStyle(sqlId, isSkinLayer)}
      onClick={(e) => handleAction(e, sqlId, isSkinLayer)}
      onMouseEnter={!isSkinLayer ? (e) => { if (parteAtiva !== sqlId) e.target.style.fill = colors.hover; } : undefined}
      onMouseLeave={!isSkinLayer ? (e) => { if (parteAtiva !== sqlId) e.target.style.fill = colors.fill; else e.target.style.fill = colors.fillSelected; } : undefined}
    >
      <title>{getNomeLegivel(isSkinLayer ? 'pele-geral' : sqlId)}</title>
    </circle>
  );

  // --- DEFINI√á√ÉO DA ESTRUTURA DO CORPO (Para n√£o repetir c√≥digo) ---
  const renderBodyStructure = (isSkinLayer) => (
    <>
      <Round sqlId="cabeca" cx="150" cy="50" r="35" isSkinLayer={isSkinLayer} />
      <Block sqlId="pescoco" x="135" y="90" w="30" h="20" radius={4} isSkinLayer={isSkinLayer} />

      {vista === 'frente' ? (
        <>
          {/* TRONCO FRENTE */}
          <Block sqlId="peito" x="110" y="115" w="80" h="65" isSkinLayer={isSkinLayer} />
          <Block sqlId="abdomen" x="115" y="185" w="70" h="60" isSkinLayer={isSkinLayer} />
          <Block sqlId="pelvis" x="115" y="250" w="70" h="40" isSkinLayer={isSkinLayer} />
          {/* BRA√áOS FRENTE */}
          <Block sqlId="ombro-esquerdo" x="200" y="115" w="35" h="40" isSkinLayer={isSkinLayer} />
          <Block sqlId="biceps-esquerdo" x="205" y="160" w="25" h="55" isSkinLayer={isSkinLayer} />
          <Block sqlId="antebraco-esquerdo" x="205" y="220" w="25" h="55" isSkinLayer={isSkinLayer} />
          <Round sqlId="mao-esquerda" cx="217" cy="295" r="15" isSkinLayer={isSkinLayer} />
          <Block sqlId="ombro-direito" x="65" y="115" w="35" h="40" isSkinLayer={isSkinLayer} />
          <Block sqlId="biceps-direito" x="70" y="160" w="25" h="55" isSkinLayer={isSkinLayer} />
          <Block sqlId="antebraco-direito" x="70" y="220" w="25" h="55" isSkinLayer={isSkinLayer} />
          <Round sqlId="mao-direita" cx="82" cy="295" r="15" isSkinLayer={isSkinLayer} />
          {/* PERNAS FRENTE */}
          <Block sqlId="coxa-esquerda" x="155" y="300" w="35" h="90" isSkinLayer={isSkinLayer} />
          <Block sqlId="canela-esquerda" x="155" y="395" w="35" h="90" isSkinLayer={isSkinLayer} />
          <Block sqlId="pe-esquerdo" x="155" y="490" w="45" h="20" radius={4} isSkinLayer={isSkinLayer} />
          <Block sqlId="coxa-direita" x="110" y="300" w="35" h="90" isSkinLayer={isSkinLayer} />
          <Block sqlId="canela-direita" x="110" y="395" w="35" h="90" isSkinLayer={isSkinLayer} />
          <Block sqlId="pe-direito" x="100" y="490" w="45" h="20" radius={4} isSkinLayer={isSkinLayer} />
        </>
      ) : (
        <>
          {/* COSTAS ESTRUTURA */}
          <Block sqlId="coluna-cervical" x="135" y="115" w="30" h="40" radius={2} isSkinLayer={isSkinLayer} />
          <Block sqlId="coluna-toracica" x="135" y="160" w="30" h="65" radius={2} isSkinLayer={isSkinLayer} />
          <Block sqlId="coluna-lombar" x="135" y="230" w="30" h="40" radius={2} isSkinLayer={isSkinLayer} />
          <Block sqlId="ombro-direito" x="170" y="115" w="65" h="40" isSkinLayer={isSkinLayer} />
          <Block sqlId="ombro-esquerdo" x="65" y="115" w="65" h="40" isSkinLayer={isSkinLayer} />
          <Block sqlId="gluteos" x="110" y="275" w="80" h="20" isSkinLayer={isSkinLayer} />
          {/* BRA√áOS COSTAS */}
          <Block sqlId="biceps-direito" x="205" y="160" w="25" h="55" isSkinLayer={isSkinLayer} />
          <Block sqlId="antebraco-direito" x="205" y="220" w="25" h="55" isSkinLayer={isSkinLayer} />
          <Round sqlId="mao-direita" cx="217" cy="295" r="15" isSkinLayer={isSkinLayer} />
          <Block sqlId="biceps-esquerdo" x="70" y="160" w="25" h="55" isSkinLayer={isSkinLayer} />
          <Block sqlId="antebraco-esquerdo" x="70" y="220" w="25" h="55" isSkinLayer={isSkinLayer} />
          <Round sqlId="mao-esquerda" cx="82" cy="295" r="15" isSkinLayer={isSkinLayer} />
          {/* PERNAS COSTAS */}
          <Block sqlId="coxa-direita" x="155" y="305" w="35" h="90" isSkinLayer={isSkinLayer} />
          <Block sqlId="canela-direita" x="155" y="400" w="35" h="90" isSkinLayer={isSkinLayer} />
          <Block sqlId="pe-direito" x="155" y="495" w="35" h="20" radius={4} isSkinLayer={isSkinLayer} />
          <Block sqlId="coxa-esquerda" x="110" y="305" w="35" h="90" isSkinLayer={isSkinLayer} />
          <Block sqlId="canela-esquerda" x="110" y="400" w="35" h="90" isSkinLayer={isSkinLayer} />
          <Block sqlId="pe-esquerdo" x="110" y="495" w="35" h="20" radius={4} isSkinLayer={isSkinLayer} />
        </>
      )}
    </>
  );

  return (
    <div style={{ width: '100%', display: 'flex', justifyContent: 'center' }}>
      <svg
        viewBox="0 0 300 650"
        style={{ height: '550px', width: 'auto', maxWidth: '100%' }}
        xmlns="http://www.w3.org/2000/svg"
      >
        <g transform="translate(0, 20)">

          {/* --- CAMADA 1: SILHUETA / PELE (FUNDO) --- */}
          {/* Desenhamos o corpo inteiro com borda grossa e cor de pele. 
              Como eles se sobrep√µem e t√™m a mesma cor, viram uma silhueta √∫nica. */}
          <g id="camada-pele-silhueta">
            {renderBodyStructure(true)}
          </g>

          {/* --- CAMADA 2: PARTES DO CORPO (FRENTE) --- */}
          {/* Desenhamos o corpo normal por cima */}
          <g id="camada-corpo-normal">
            {renderBodyStructure(false)}
          </g>

        </g>
      </svg>
    </div>
  );
};

export default CorpoHumano;
</file>

</files>
